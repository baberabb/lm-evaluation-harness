name: Generate Tasks Summary on Push

on:
  push:
    branches:
      - 'tasktable'

jobs:
  generate-summary:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install yq (Go version)
        run: |
          sudo add-apt-repository ppa:rmescandon/yq
          sudo apt update
          sudo apt install yq -y

      - name: Generate Tasks Summary Table
        run: |
          cd lm_eval/tasks
          output_file="tasks_summary.md"
          echo "Task | Group | Output Type | Metadata" > "$output_file"
          echo "--- | --- | --- | ---" >> "$output_file"
          find . -type f -name '*.yaml' | while read -r file; do
              task=$(yq e '.task' "$file")
              task=${task:-"N/A"}

              include_file=$(yq e '.include' "$file")
              if [ -n "$include_file" ]; then
                  include_path=$(dirname "$file")/"$include_file"
                  group=$(yq e '.group[]' "$include_path")
                  output_type=$(yq e '.output_type' "$include_path")
                  metadata=$(yq e '.metadata' "$include_path")
              else
                  group=$(yq e '.group[]' "$file")
                  output_type=$(yq e '.output_type' "$file")
                  metadata=$(yq e '.metadata' "$file")
              fi

              group=${group:-"N/A"}
              output_type=${output_type:-"N/A"}
              metadata=${metadata:-"N/A"}

              echo "$task | $group | $output_type | $metadata" >> "$output_file"
          done

      - name: Add and Commit Changes
        uses: EndBug/add-and-commit@v9
